import{_ as j,d as l,b as g,s as f}from"./index-CmUZZITA.js";import{o as k,f as A,g as z,G as C,e as O}from"./vendor-C5FfeEaS.js";const q={width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},$=["fill","stroke"],W={__name:"IconHeart",props:{isFavorited:{type:Boolean,default:!1}},emits:["click"],setup(i,{emit:e}){return(s,d)=>(k(),A("div",{class:C(["icon-button heart-icon",{favorited:i.isFavorited}]),onClick:d[0]||(d[0]=n=>s.$emit("click"))},[(k(),A("svg",q,[z("path",{d:"M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z",fill:i.isFavorited?"#e74c3c":"none",stroke:i.isFavorited?"#e74c3c":"#ACABB5","stroke-width":"2"},null,8,$)]))],2))}},J=j(W,[["__scopeId","data-v-4c0fd7f5"]]),M=O("favorites",{state:()=>({favorites:[],indexedDBDisabled:!1}),getters:{isFavorited:i=>e=>i.favorites.some(s=>s.word_id===e),getFavoriteWords:i=>i.favorites.map(e=>e.word_data)},actions:{cleanWordData(i){return{id:i.id,chinese:i.chinese,romaji:i.romaji,english:i.english,classification:i.classification,audioid:i.audioid,audio_url:i.audio_url,taiwanese:i.taiwanese,english_mknoll:i.english_mknoll,simplified:i.simplified,pinyin:i.pinyin,english_ccedict:i.english_ccedict,zhuyin:i.zhuyin,type:i.type,created_at:i.created_at,sort:i.sort,definitions:i.definitions?i.definitions.map(e=>({defid:e.defid,wordid:e.wordid,partofspeech:e.partofspeech,def_chinese:e.def_chinese,def_english:e.def_english})):[]}},deepCleanForStorage(i){try{return JSON.parse(JSON.stringify(i))}catch(e){return console.error("Error cleaning object for storage:",e),null}},async loadFromIndexedDB(){if(this.indexedDBDisabled){console.log("IndexedDB disabled for favorites, skipping load");return}try{this.favorites=await l.favorites.toArray()}catch(i){console.error("Error loading favorites from IndexedDB:",i),this.favorites=[],this.indexedDBDisabled=!0}},async loadFromSupabase(){var i,e,s,d,n,r,u,v,p,S,m,y,w,D,b,B,x;try{const _=g();if(_.isAuthenticated){const{data:F,error:E}=await f.from("favorites").select("*").eq("user_id",_.user.id).order("created_at",{ascending:!1});if(E){console.error("Error loading favorites from Supabase:",E);return}if(F&&(this.favorites=F.map(o=>{var t,c,a,I;const h=this.deepCleanForStorage({id:o.id,word_id:o.word_id,word_data:o.word_data,created_at:o.created_at});return h||{id:o.id||Date.now(),word_id:o.word_id,word_data:{id:(t=o.word_data)==null?void 0:t.id,chinese:((c=o.word_data)==null?void 0:c.chinese)||"",english:((a=o.word_data)==null?void 0:a.english)||"",romaji:((I=o.word_data)==null?void 0:I.romaji)||""},created_at:o.created_at||new Date().toISOString()}}),!this.indexedDBDisabled))try{await l.favorites.clear(),console.log("Attempting to add favorites to IndexedDB:",this.favorites.length,"items");const o=[];for(const[h,t]of this.favorites.entries())try{const c={id:t.id||Date.now()+h,word_id:t.word_id||0,word_data:{id:((i=t.word_data)==null?void 0:i.id)||0,chinese:String(((e=t.word_data)==null?void 0:e.chinese)||""),english:String(((s=t.word_data)==null?void 0:s.english)||""),romaji:String(((d=t.word_data)==null?void 0:d.romaji)||""),classification:String(((n=t.word_data)==null?void 0:n.classification)||""),audioid:((r=t.word_data)==null?void 0:r.audioid)||null,audio_url:String(((u=t.word_data)==null?void 0:u.audio_url)||""),taiwanese:String(((v=t.word_data)==null?void 0:v.taiwanese)||""),english_mknoll:String(((p=t.word_data)==null?void 0:p.english_mknoll)||""),simplified:String(((S=t.word_data)==null?void 0:S.simplified)||""),pinyin:String(((m=t.word_data)==null?void 0:m.pinyin)||""),english_ccedict:String(((y=t.word_data)==null?void 0:y.english_ccedict)||""),zhuyin:String(((w=t.word_data)==null?void 0:w.zhuyin)||""),type:String(((D=t.word_data)==null?void 0:D.type)||""),created_at:String(((b=t.word_data)==null?void 0:b.created_at)||""),sort:((B=t.word_data)==null?void 0:B.sort)||0,definitions:Array.isArray((x=t.word_data)==null?void 0:x.definitions)?t.word_data.definitions.map(a=>({defid:(a==null?void 0:a.defid)||0,wordid:(a==null?void 0:a.wordid)||0,partofspeech:String((a==null?void 0:a.partofspeech)||""),def_chinese:String((a==null?void 0:a.def_chinese)||""),def_english:String((a==null?void 0:a.def_english)||"")})):[]},created_at:String(t.created_at||new Date().toISOString())};await l.favorites.add(c),o.push(c)}catch(c){console.error(`Error adding favorite item ${h}:`,c,t)}console.log(`Successfully added ${o.length} out of ${this.favorites.length} favorites to IndexedDB`)}catch(o){console.error("Error syncing favorites to IndexedDB:",o),this.indexedDBDisabled=!0,console.warn("Disabling IndexedDB sync for favorites due to persistent errors")}}}catch(_){console.error("Error loading favorites from Supabase:",_)}},async addFavorite(i){try{const e=this.cleanWordData(i),s={word_id:i.id,word_data:e,created_at:new Date().toISOString()};if(this.favorites.unshift(s),!this.indexedDBDisabled)try{const n={id:Date.now()+Math.random(),word_id:i.id||0,word_data:{id:i.id||0,chinese:String(i.chinese||""),english:String(i.english||""),romaji:String(i.romaji||""),classification:String(i.classification||""),audioid:i.audioid||null,audio_url:String(i.audio_url||""),taiwanese:String(i.taiwanese||""),english_mknoll:String(i.english_mknoll||""),simplified:String(i.simplified||""),pinyin:String(i.pinyin||""),english_ccedict:String(i.english_ccedict||""),zhuyin:String(i.zhuyin||""),type:String(i.type||""),created_at:String(i.created_at||""),sort:i.sort||0,definitions:Array.isArray(i.definitions)?i.definitions.map(r=>({defid:(r==null?void 0:r.defid)||0,wordid:(r==null?void 0:r.wordid)||0,partofspeech:String((r==null?void 0:r.partofspeech)||""),def_chinese:String((r==null?void 0:r.def_chinese)||""),def_english:String((r==null?void 0:r.def_english)||"")})):[]},created_at:new Date().toISOString()};await l.favorites.add(n)}catch(n){console.error("Error saving favorite to IndexedDB:",n),this.indexedDBDisabled=!0,console.warn("Disabling IndexedDB for favorites due to error")}const d=g();if(d.isAuthenticated)try{const{data:n,error:r}=await f.from("favorites").insert({user_id:d.user.id,word_id:i.id,word_data:e}).select();r&&console.error("Error saving favorite to Supabase:",r)}catch(n){console.error("Error with Supabase operation:",n)}}catch(e){console.error("Error adding favorite:",e),this.favorites=this.favorites.filter(s=>s.word_id!==i.id)}},async removeFavorite(i){try{this.favorites=this.favorites.filter(s=>s.word_id!==i),await l.favorites.where("word_id").equals(i).delete();const e=g();if(e.isAuthenticated){const{error:s}=await f.from("favorites").delete().eq("user_id",e.user.id).eq("word_id",i);s&&console.error("Error removing favorite from Supabase:",s)}}catch(e){console.error("Error removing favorite:",e)}},async toggleFavorite(i){this.isFavorited(i.id)?await this.removeFavorite(i.id):await this.addFavorite(i)},async clearFavorites(){try{this.favorites=[],await l.favorites.clear();const i=g();if(i.isAuthenticated){const{error:e}=await f.from("favorites").delete().eq("user_id",i.user.id);e&&console.error("Error clearing favorites from Supabase:",e)}}catch(i){console.error("Error clearing favorites:",i)}}}});export{J as I,M as u};
